# Active Context

## Mevcut Odak
Proje v1 kapanis durumu: tek komutla uctan uca akisi calisan, QA gate destekli M1->M2->M3 dublaj sistemi.

## Handoff Snapshot (2026-02-20)
- Son test durumu: `python -m pytest -q` -> `74 passed` (2026-02-20).
- CLI komutlari:
  - `doctor`
  - `run-m1`
  - `run-dub`
  - `prepare-m2`
  - `run-m2`
  - `benchmark-m2`
  - `prepare-m3`
  - `run-m3`
  - `benchmark-m3`
  - `report-m3-tuning`
  - `finalize-m3-profile`
  - `tune-m3-espeak`
  - `finish-m3`
  - `ui`
- M3 su an `mock` ve `espeak` backendleri ile calisiyor.
- Calisma agaci temiz degil (commit edilmemis degisiklikler var).
- Eklenen yeni M3 dosyalari:
  - `src/video_translate/pipeline/m3.py`
  - `src/video_translate/pipeline/m3_prep.py`
  - `src/video_translate/qa/m3_report.py`
  - `src/video_translate/tts/contracts.py`
  - `src/video_translate/tts/backends.py`
  - `src/video_translate/tts/__init__.py`
  - `tests/test_m3_pipeline.py`
  - `tests/test_m3_prep.py`
  - `tests/test_m3_qa_report.py`
  - `docs/milestones/m3.md`
  - `configs/profiles/gtx1650_espeak.toml`

## Son Degisiklikler
- M1 kod tabani olusturuldu (`src/video_translate`).
- `run-m1` CLI komutu eklendi.
- `doctor` CLI komutu eklendi (ortam on kontrolu).
- Ingest modulleri eklendi (`yt-dlp` indirme, `ffmpeg` normalize).
- ASR modulu eklendi (`faster-whisper`, zaman damgali transcript).
- JSON ve SRT transcript ciktilari eklendi.
- Run izlenebilirligi icin `run_manifest.json` eklendi.
- Konfigurasyon deger dogrulamasi eklendi (gecersiz degerlerde erken hata).
- M1 otomatik kalite raporu eklendi (`output/qa/m1_qa_report.json`).
- `prepare-m2` komutu eklendi.
- M2 ceviri giris sozlesmesi eklendi (`output/translate/translation_input.en-tr.json`).
- `run-m2` komutu eklendi.
- M2 ceviri cikti sozlesmesi eklendi (`output/translate/translation_output.en-tr.json`).
- M2 QA raporu eklendi (`output/qa/m2_qa_report.json`).
- Ceviri backend katmani eklendi (`mock`, `transformers`).
- `run-m2` komutu ile smoke test calistirildi (mock backend).
- M2 terminoloji sozlugu destegi eklendi (`configs/glossary.en-tr.json`).
- M2 ceviri sonrasi glossary postprocess eklendi.
- M2 QA'ya terminal noktalama kontrolu eklendi.
- M2 QA'ya glossary eslesme/kacirma metrikleri eklendi.
- M2 QA'ya uzun segment akicilik kontrolleri eklendi:
  - terminal noktalama eksigi
  - asiri duraklama noktalama yogunlugu (`,`, `;`, `:`)
- M2 QA uzun-segment esikleri konfigurasyona tasindi:
  - `translate.qa_check_long_segment_fluency`
  - `translate.qa_long_segment_word_threshold`
  - `translate.qa_long_segment_max_pause_punct`
- M2 QA kabul kapisi eklendi:
  - `translate.qa_fail_on_flags` ile kalite bayragi varsa kosuyu fail etme
  - `translate.qa_allowed_flags` ile izinli kalite bayragi whitelist'i
- M2 run manifest'e `qa_gate` sonucu eklendi (`enabled/passed/blocked_flags`).
- ASR GPU OOM fallback mekanizmasi eklendi (CPU'ya otomatik gecis).
- GTX1650 + i5-12500H icin profil config eklendi (`configs/profiles/gtx1650_i5_12500h.toml`).
- Doctor M2 bagimlilik kontrolu eklendi (`transformers/sentencepiece/torch`).
- GTX1650 profil bagimliliklari kuruldu ve doctor dogrulamasi basarili.
- M2 hizlandirma: tekrar eden kaynak segmentleri tek sefer cevirme (dedup reuse).
- M2 calisma manifesti eklendi (`run_m2_manifest.json`) - hiz ve sure metrikleri.
- GTX1650 icin hiz odakli ikinci profil eklendi (`configs/profiles/gtx1650_fast.toml`).
- GTX1650 icin strict kalite profili eklendi (`configs/profiles/gtx1650_strict.toml`).
- GTX1650 icin `espeak` TTS profili eklendi (`configs/profiles/gtx1650_espeak.toml`).
- `benchmark-m2` komutu eklendi (profil bazli karsilastirma).
- Benchmark raporu eklendi (`benchmarks/m2_profile_benchmark.json`).
- M2 transformers modeli `facebook/m2m100_418M` olarak guncellendi.
- `prepare-m3` komutu eklendi (M2 translation output -> M3 TTS input).
- `run-m3` komutu eklendi (segment bazli TTS uretimi + M3 QA).
- M3 TTS contract katmani eklendi (`tts_input` / `tts_output`).
- M3 mock TTS backend eklendi (yerel sine-wave uretimi, pipeline dogrulama amacli).
- M3 QA raporu eklendi (`output/qa/m3_qa_report.json`).
- M3 QA gate eklendi (`tts.qa_fail_on_flags`, `tts.qa_allowed_flags`).
- M3 run manifest eklendi (`run_m3_manifest.json`).
- TTS konfigurasyon blogu eklendi (`[tts]`).
- M3 milestone dokumani olusturuldu (`docs/milestones/m3.md`).
- M3'e gercek yerel `espeak` backend eklendi (`tts.backend = espeak`).
- TTS config genisletildi:
  - `tts.espeak_bin`
  - `tts.espeak_voice`
  - `tts.espeak_speed_wpm`
  - `tts.espeak_pitch`
- Doctor/preflight TTS backend kontrolu genisletildi (`espeak` binary denetimi).
- GTX1650 icin `espeak` profili eklendi (`configs/profiles/gtx1650_espeak.toml`).
- TTS backend unit testleri eklendi (`tests/test_tts_backends.py`).
- M1 dokumani eklendi (`docs/milestones/m1.md`).
- M2 dokumani tamamlandi (`docs/milestones/m2.md`).
- Temel birim testleri genisletildi ve gecti.
- M1 gercek URL kosulari tamamlandi:
  - `runs/finalize_m1m2/m1_real_small_cpu`
  - `runs/finalize_m1m2/m1_real_medium_cpu`
- M2 gercek kosu `quality_flags: []` ile tamamlandi.
- M2 benchmark sonucu `gtx1650_fast` profilini onerdi.
- `translate.backends` mojibake onarimi guclendirildi ve testlerle dogrulandi.
- M3 pipeline'a stitched preview artefakti eklendi:
  - `output/tts/tts_preview_stitched.<lang>.wav`
  - `run_m3_manifest.json` -> `outputs.stitched_preview_wav`
- `run-m3` CLI cikti mesajina stitched preview yolu eklendi.
- M3 mock backend ile gercek run dogrulandi (`runs/finalize_m1m2/m1_real_medium_cpu`).
- Not: Bu ortamda `espeak` PATH'te olmadigi icin `run-m3 --config configs/profiles/gtx1650_espeak.toml` preflight'ta duruyor.
- M3 `espeak` backend'e adaptif speaking-rate mekanizmasi eklendi:
  - hedef sureye gore hiz guncelleme (bounded retry)
  - yeni config alanlari: `espeak_adaptive_rate_*`
- GTX1650 profilleri ve varsayilan config bu yeni TTS alanlariyla guncellendi.
- M3 profile benchmark komutu eklendi (`benchmark-m3`).
- Yeni benchmark pipeline: `src/video_translate/pipeline/m3_benchmark.py`
- M3 benchmark raporu uretimi dogrulandi:
  - `runs/finalize_m1m2/m1_real_medium_cpu/benchmarks/m3_profile_benchmark.json`
- M3 benchmark stitched preview dosyalari profil bazli ayrildi:
  - `benchmarks/tts_preview_stitched.<profile>.wav`
- M3 tuning markdown rapor komutu eklendi:
  - `report-m3-tuning`
  - pipeline: `src/video_translate/pipeline/m3_tuning_report.py`
- Gercek run uzerinde tuning raporu uretildi:
  - `runs/finalize_m1m2/m1_real_medium_cpu/benchmarks/m3_tuning_report.md`
- M3 backend ile bagli lokal UI eklendi:
  - `src/video_translate/ui.py`
  - `video-translate ui --host 127.0.0.1 --port 8765`
  - test: `tests/test_ui.py`
- Windows one-click acilis scripti stabilize edildi:
  - `open_project.bat`
  - Akis: `.venv` -> `pip install -e .[dev,m2]` -> `doctor` -> `ui`
  - `--skip-install` ve `--no-ui` bayraklari dogrulandi
  - CMD parser hatasi (`if (...)` icinde kapanis parantezi) giderildi
- UI YouTube entegrasyonu eklendi:
  - `src/video_translate/ui.py`
  - Yeni endpoint: `POST /run-youtube-dub`
  - Yeni is akisi: URL -> `run_m1` -> `prepare_m2` -> `run_m2` -> (opsiyonel) `prepare_m3` -> `run_m3`
  - Mevcut `POST /run-m3` akisiyla birlikte ayni panelde calisiyor
  - Test: `tests/test_ui.py::test_execute_youtube_dub_run_full_chain`
- UI cache gorunurluk sorunu icin no-cache response basliklari eklendi.
- UI icine gorunur build etiketi eklendi:
  - `UI Build: 2026-02-20-final-mp4-downloads`
- M3 sure uyumu iyilestirildi:
  - kisa kalan segment WAV'lerine hedef sureye kadar sessizlik padding uygulanir
  - `run_m3_manifest.json` icinde `duration_postfit` metrikleri yazilir
  - test: `tests/test_m3_pipeline.py::test_run_m3_pipeline_pads_short_segments_with_silence`
- M3 sure uyumu ikinci adim:
  - uzun kalan segment WAV'lerinde hedef sureye trim uygulanir
  - `duration_postfit.trim_applied_segments` ve `duration_postfit.total_trimmed_seconds` eklendi
  - test: `tests/test_m3_pipeline.py::test_run_m3_pipeline_trims_long_segments`
- M3 benchmark/tuning raporlari guclendirildi:
  - benchmark JSON'ina post-fit segment/sure metrikleri eklendi
  - tuning markdown tablosuna post-fit pad/trim kolonlari eklendi
  - testler: `tests/test_m3_benchmark.py`, `tests/test_m3_tuning_report.py`
- M3 finalizasyon komutu eklendi:
  - `pipeline.m3_finalize.finalize_m3_profile_selection`
  - `cli.finalize-m3-profile`
  - benchmark onerilen profili `configs/profiles/m3_recommended.toml` dosyasina kilitler
  - secim ozetini `benchmarks/m3_profile_selection.json` olarak yazar
  - test: `tests/test_m3_finalize.py`
- M3 QA post-fit guard eklendi:
  - yeni config alanlari: `tts.qa_max_postfit_segment_ratio`, `tts.qa_max_postfit_seconds_ratio`
  - QA raporu post-fit oranlarini hesaplar ve asimlarda bayrak uretir
  - bayraklar: `postfit_segment_ratio_above_max`, `postfit_seconds_ratio_above_max`
  - `qa_fail_on_flags=true` ise gate bu bayraklarla run'i durdurabilir
  - testler: `tests/test_m3_qa_report.py`, `tests/test_m3_pipeline.py`, `tests/test_config.py`
- M3 espeak tuning otomasyonu eklendi:
  - `pipeline.m3_espeak_tune.run_m3_espeak_tuning_automation`
  - `cli.tune-m3-espeak`
  - aday profil uretimi + benchmark + tuning report + finalize zinciri
  - test: `tests/test_m3_espeak_tune.py`
- M3 kapanis workflow'u eklendi:
  - `pipeline.m3_closure.run_m3_closure_workflow`
  - `cli.finish-m3`
  - akis: prepare + (opsiyonel auto-tune) + strict QA gate final run
  - rapor: `benchmarks/m3_closure_report.json`
  - test: `tests/test_m3_closure.py`
- M3 dosya adlandirma standardi duzeltildi:
  - `src/video_translate/pipeline/m3_finish.py` -> `src/video_translate/pipeline/m3_closure.py`
  - `tests/test_m3_finish.py` -> `tests/test_m3_closure.py`
  - CLI import/cagri referanslari `m3_closure` uzerine alindi.
- UI YouTube giris gorunurlugu guclendirildi:
  - `src/video_translate/ui.py` icinde "YouTube Link Ekle" odak kutusu eklendi.
  - YouTube kontrol gorunurlugu testle sabitlendi: `tests/test_ui.py::test_html_page_contains_visible_youtube_controls`.
- UI icine kullanim kolayligi icin text objesi eklendi:
  - "CLI Kullanim Komutlari" panelinde `run-dub` ve `--m3-closure` komutlari gosteriliyor.
  - test: `tests/test_ui.py::test_html_page_contains_visible_youtube_controls`.
- UI ana sayfa metinleri production odaga cekildi:
  - Baslik: `Video Translate Studio`
  - Aciklama: test/demo dili yerine ana operasyon dili
  - Build etiketi dynamic hale getirildi (`UI_DEMO_VERSION`)
  - M3 ikincil alan etiketi: "Gelişmis M3 araci (opsiyonel...)"
- Canli ortamda eski UI gorunme kok nedeni bulundu:
  - Ayni portta (`8765`) iki farkli `python -m video_translate.cli ui` process LISTENING durumundaydi.
  - Baglanti bazen eski process'e dustugu icin eski "M3 UI" gorunuyordu.
  - `open_project.bat` icine porttaki eski processleri otomatik kapatma adimi eklendi.
- `open_project.bat` parser hatasi giderildi:
  - UI acilisindan hemen once gorulen `... was unexpected at this time.` hatasi, batch `for`/`findstr` blok parser kirilmasindan kaynaklaniyordu.
  - Port temizleme adimi tek satir PowerShell komutuna cevrildi.
  - Dogrulama: script `--skip-install --no-ui` modunda temiz cikti, normal modda UI sureci acik kaldi.
- ASR CUDA DLL fallback guclendirildi:
  - YouTube akisi sirasinda gorulen `Library cublas64_12.dll is not found or cannot be loaded` hatasi icin CPU fallback eklendi.
  - `asr.whisper._is_probable_oom_error` CUDA runtime DLL eksikligi mesajlarini da kapsayacak sekilde genisletildi.
  - test guncellendi: `tests/test_asr_fallback.py`.
- ASR fallback politikasi sertlestirildi:
  - Ilk deneme `cuda`/primary ayarlarla basarisiz olursa ve fallback ayarlari primary'den farkliysa, hata turune bakmadan CPU fallback denenir.
  - Bu sayede CUDA kutuphane yukleme hatalarinda da akis kesilmez.
  - ek test: `test_transcribe_audio_falls_back_on_non_oom_when_primary_is_cuda`.
- ASR fallback kok neden analizi tamamlandi:
  - `faster-whisper` tarafinda hata bazi durumlarda `model.transcribe()` cagrisi sirasinda degil, donen generator iterasyonunda firtliyor.
  - Onceki try/except sadece ilk cagrida oldugu icin bu hata fallback'e dusmeden yukari cikiyordu.
  - `asr.whisper` icine generator'i erken materialize eden `_transcribe_and_collect` eklendi; iterasyon hatasi da fallback kapsamina alindi.
  - ek test: `test_transcribe_audio_falls_back_when_generator_raises_on_iteration`.
  - canli dogrulama: `run-m1` komutu ve `POST /run-youtube-dub` akisi `ok=true` dondu.
- Uctan uca tek-komut akis eklendi:
  - `pipeline.full_run.run_full_dub_pipeline`
  - `cli.run-dub`
  - URL -> M1 -> prepare-m2 -> run-m2 -> prepare-m3 -> run-m3
  - opsiyonel `--m3-closure` ile `finish-m3` zinciri ayni komuttan aktif edilebilir
  - test: `tests/test_full_run_pipeline.py`
- UI cikti erisimi guclendirildi:
  - `src/video_translate/ui.py` icine guvenli indirme endpoint'i eklendi: `GET /download?path=...`
  - Endpoint yalnizca repo root altindaki dosyalari indirir (path traversal engeli).
  - YouTube ve M3 yanitlarina `output_dir` ve `downloadables` alanlari eklendi.
  - UI panelinde `Cikti klasoru` ve `Indirilebilir Dosyalar` bolumleri gorunur hale getirildi.
  - testler guncellendi: `tests/test_ui.py`
- UI adlandirma standardi uretim odagina alindi:
  - `src/video_translate/ui.py`
  - CLI komutu: `video-translate ui`
  - Dokuman: `docs/ui.md`
  - test dosyasi: `tests/test_ui.py`
- Final teslim akisi eklendi (YouTube -> Turkce MP4):
  - yeni modul: `src/video_translate/pipeline/delivery.py`
  - M3 stitched audio + kaynak video ffmpeg ile birlestirilir
  - final cikti: `downloads/<run_id>/video_dubbed.tr.mp4`
  - kalite ozeti: `downloads/<run_id>/quality_summary.tr.json`
  - UI YouTube akisinda varsayilan: ara dosyalari temizle (`cleanup_intermediate=true`)
  - run workspace temizligi: `runs/<run_id>` klasoru basarili teslim sonrasi silinir
  - UI indirilebilir liste yalniz final MP4'e indirgenir
  - UI build etiketi: `2026-02-20-final-mp4-downloads`
  - testler: `tests/test_delivery.py`, `tests/test_ui.py`
- UI YouTube ilerleme gorunurlugu guclendirildi:
  - `POST /run-youtube-dub` cevabi asenkron job payload'i (`job_id`, `status`, `progress_percent`, `phase`) doner.
  - `GET /job-status?job_id=...` polling ile canli durum izlenir.
  - UI'da ilerleme cubugu + `%` metni + faz metni (M1/M2/M3/final) anlik guncellenir.
  - test guncellemesi: `tests/test_ui.py` YouTube progress assertleri.
- Son dogrulama:
  - `python -m pytest -q` -> `70 passed` (2026-02-20).
- TTS beep kok nedeni kapatildi:
  - Kullanim profillerinde `tts.backend = mock` oldugu icin final cikti test tonu (diiit/duuut) uretiyordu.
  - Profiller gercek sese alindi:
    - `configs/profiles/gtx1650_i5_12500h.toml`
    - `configs/profiles/gtx1650_fast.toml`
    - `configs/profiles/gtx1650_strict.toml`
    - hepsi `tts.backend = "espeak"`
  - Final teslim guvencesi eklendi:
    - `pipeline.full_run.run_full_dub_pipeline` mock backend ile calismaz
    - `ui.execute_youtube_dub_run` mock backend ile calismaz
    - net hata mesaji ile `espeak` profiline yonlendirir
  - testler:
    - `tests/test_full_run_pipeline.py::test_run_full_dub_pipeline_rejects_mock_tts_backend`
    - `tests/test_ui.py::test_execute_youtube_dub_run_rejects_mock_tts_backend`
  - Son dogrulama: `python -m pytest -q` -> `74 passed` (2026-02-20).
- eSpeak command fallback guclendirildi:
  - Preflight, `espeak` yoksa otomatik `espeak-ng` komutunu da dener.
  - TTS backend build asamasinda da ayni fallback uygulanir (`espeak` <-> `espeak-ng`).
  - testler:
    - `tests/test_preflight.py::test_run_preflight_espeak_backend_accepts_espeak_ng_fallback`
    - `tests/test_tts_backends.py::test_build_tts_backend_espeak_prefers_espeak_ng_when_espeak_missing`

## Aktif Kararlar
- Gelistirme `M1 -> M5` kademeleriyle ilerleyecek.
- Ilk uygulama hedefi `M1` (ingest + ASR + zaman damgalari).
- Proje boyunca gereksiz dosya ve debug artigi birakilmayacak.
- Kod ve klasor adlandirmalari profesyonel ve tutarli olacak.
- Uretim klasor/adlandirma tarafinda `demo/test` ifadesi kullanilmayacak; test dosyalari yalnizca `tests/` altinda tutulacak.
- Gecici debug ciktilari yalnizca debug amacli ayrik alanda tutulacak.

## Sonraki Adimlar
- Bu repo kapsaminda zorunlu teknik adim kalmadi; sonraki isler yeni faz/backlog olarak acilabilir.

## Sonraki Model Icin Net Baslangic Akisi
1. `git status --short` ile degisiklikleri gor.
2. `python -m pytest -q` ile tabani dogrula.
3. `video-translate run-dub --url "<youtube_url>" --config configs/profiles/gtx1650_i5_12500h.toml` calistir.
4. Gerekirse strict kapanis icin `--m3-closure` ac.
5. `run_root` altindaki `output/qa/m2_qa_report.json`, `output/qa/m3_qa_report.json`, `run_m3_manifest.json` dosyalarini kontrol et.

## Dikkat Notlari
- Senkron hedefi yuksek, fakat lip reading kullanilmayacak.
- Kaliteyi guvencelemek icin metrik odakli QA en bastan planlanacak.


